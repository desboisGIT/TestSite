{% extends 'layout/layout.html' %}
{% load custom_tags %}

{% block content %}
<div class="bodyPage" style="display: flex;">
    <!-- Sidebar -->
    <nav id="sidebar" class="col-md-2 d-md-block text-white sidebar" style="background-color: rgb(29, 29, 29);">
        <div class="position-sticky pt-3">
            <h5 class="text-center">Side Menu</h5>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <form method="GET" class="mt-4">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="filter" class="form-label" id="price_label">Price:</label>
                            <input type="number" min="0" max="2000" id="cursor_price" step="0.01"
                                class="form-control">
                        </div>
                    </form>
                </li>
            </ul>
            <form method="GET" class="mt-4">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="sort_by" class="form-label">Sort By:</label>
                    <select name="sort_by" class="form-control">
                        <option value="default">Default</option>
                        <option value="price">Price</option>
                        <option value="date">Date of publication</option>
                    </select>
                </div>
                <div class="mb-3">
                    <br>
                </div>
                <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
            </form>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4" style="overflow: auto;">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <a href="{% url 'accounts:search_beatmakers' %}">Search Beatmakers</a>
            <form method="GET" class="w-100">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" id="search" name="search" class="form-control" placeholder="Search..."
                        value="{{ search_term }}">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>

        <!-- Content Area with Beats -->
        <div style="height: calc(100vh - 220px); overflow-y: auto; margin-top: 20px; padding-top: 20px; padding-right: 20px; padding-left: 20px;">
            {% if beats %}
            {% for beat in beats %}
            <div id="beat_{{ beat.id }}"
                style="border-radius: 4px; padding: 0px; margin-bottom: 10px; position: relative;">
                <div id="THEDIV" style="display: flex; flex-wrap: wrap; position: relative;">
                    <div style="flex: 1 0 200px; margin-right: 20px; position: relative; overflow: hidden;">
                        <div style="position: relative;">
                          <button class="play-btn" onclick="playAudio({{ beat.id }})">Play</button> <!-- ERREUR NORMAL C MARCHE TKT PAS TOUCHE-->
                            <img class="rounded square-image-small gradientDiv" src="{{ beat.cover_image.url }}"
                                alt="{{ beat.title }} Cover" style="width: 100%; border-radius: 1px; top: 65px;">
                                {% if beat.title|upper|length > 9 %} <!-- NE PAS §§§ CHANGER §§§  !!! DANGER DE MORT-->
                                <h1 style="position: absolute; top:95px; left:10px;"><strong>{{ beat.title|uppercase_and_slice }}...
                                </strong></h1>
                                {% else %}
                                <h1 style="position: absolute; top:95px; left:10px;"><strong>{{ beat.title.upper }}</strong></h1>
                                {% endif %}
                            <div style="position: relative; top: 20px; left: 65%; background-color: rgba(31, 31, 31, 0.473); width: 220px; max-height: 80px;">
                                <h1 style="overflow-wrap: break-word;">
                                    <strong>{{ beat.artist }}</strong>
                                </h1>
                                {% if beat.artist|get_artist_rank == 'admin' %}
                                <p style="position: absolute; color: red;">
                                    <strong>{{ beat.artist|get_artist_rank }}</strong>
                                </p>
                                {% else %}
                                <p style="position: absolute;">
                                    <strong>{{ beat.artist|get_artist_rank }}</strong>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        <img class="square-image-small" src="{{ beat.cover_image.url }}"
                            alt="{{ beat.title }} Cover Overlay" style="
                            width: 140px;
                            height: 140px;
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            -webkit-border-top-right-radius: 20px;
                            -webkit-border-bottom-right-radius: 4px;
                            -moz-border-radius-topright: 4px;
                            -moz-border-radius-bottomright: 4px;
                            border-top-right-radius: 4px;
                            border-bottom-right-radius: 4px;">
                    </div>
                    <div style="flex: 2 0 0; margin-right: 20px; display: flex; flex-wrap: wrap; padding-bottom: 20px; padding-top: 20px;">
                        <div style="display: flex;">
                            <p style="color: #666; margin-bottom: 5px;">{{ beat.genre }} - {{ beat.release_date }}</p>
                            <p style="margin-bottom: 10px;">{{ beat.description }}</p>
                        </div>
                        {% if beat.audio_file_url %}
                        <div style="width: 100%; margin-top: 10px;">
                            <audio id="audio_{{ beat.id }}" controls style="width: 100%;">
                                <source src="{{ beat.audio_file_url }}" type="audio/mp3">
                                Your browser does not support the audio element.
                            </audio>
                            <div style="min-height: 54px; min-width: 815.22;">
                              <h3> <strong>{{ beat.price }} €</strong></h3>
                            </div>
                              
                        </div>
                        {% else %}
                        <p style="color: #999;">Audio file not found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p style="color: #999;">No beats uploaded yet.</p>
            {% endif %}
        </div>

        <!-- Optional: Display Error Message -->
        {% if error %}
        <div class="alert alert-warning" role="alert">
            {{ error }}
        </div>
        {% endif %}

    </main>
</div>

<style>
    h1 {
        font-size: 200%;
    }

    .gradientDiv {
        position: absolute;
        top: 50px;
        left: 0;
        transform: translate(-50%, -50%);
        -webkit-mask-image: -webkit-gradient(linear, left top, right top, from(rgba(0, 0, 0, 1)),
            to(rgba(0, 0, 0, 0)));
        mask-image: linear-gradient(to right, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0));
    }

    audio {
    display: none;
}

    audio::-webkit-media-controls-panel {
        background-color: rgb(51, 51, 51);
    }

    .audio-controls {
        display: flex;
        justify-content: center;
        margin-top: 5px;
    }

    .audio-controls button {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
    }
    .play-btn{
      position: absolute;
      
    }

    .audio-controls button:hover {
        background-color: #0056b3;
    }

    #THEDIV{
      transition: all, 0.1s ease-in;
    }
    #THEDIV:hover{
      -webkit-box-shadow: 0px 0px 16px 8px rgba(0,0,0,0.61); 
      box-shadow: 0px 0px 16px 8px rgba(0,0,0,0.61);
      margin-bottom: 12px;
      background-color: #2d373f79;
    }
</style>

<script>
    // JavaScript functions to control audio playback
    function playAudio(beatId) {
        var audio = document.getElementById('audio_' + beatId);
        audio.play();
    }

    function pauseAudio(beatId) {
        var audio = document.getElementById('audio_' + beatId);
        audio.pause();
    }
</script>

{% endblock content %}
