{% extends 'layout/layout.html' %}
{% load custom_tags %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static "css/extra.css" %}">
<div class="bodyPage" style="display: flex; flex-direction: row;">
  <nav id="sidebar" class="col-md-2 d-md-block text-white sidebar" style="background-color: rgb(29, 29, 29); width: 160px; display: flex; flex-direction: column;">
    <div class="position-sticky pt-3" style="flex-grow: 1;">
        <h5 class="text-center">Side Menu</h5>
        <ul class="nav flex-column">
        </ul>
        <form method="GET" class="mt-4">
            {% csrf_token %}
            <div class="mb-3">
                <label for="sort_by" class="form-label">Sort By:</label>
                <select name="sort_by" class="form-control">
                    <option value="default">Default</option>
                    <option value="price">Price</option>
                    <option value="date">Date of publication</option>
                </select>
            </div>
            <div class="mb-3">
                <br>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
        </form>
    </div>
</nav>
<div id="arrowdiv" class="{% if sidebar_collapsed %}collapsed{% endif %}">
  {% if sidebar_collapsed %}
    <i class="fa-solid fa-chevron-right" style="color: #ffffff;"></i>
  {% else %}
    <i class="fa-solid fa-chevron-left" style="color: #ffffff;"></i>
  {% endif %}
</div>
<!-- Main Content -->
<main id="main-content" class="col-12" style="overflow: auto;">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <a href="{% url 'accounts:search_beatmakers' %}">Search Beatmakers</a>
        <form method="GET" class="w-100">
            {% csrf_token %}
            <div class="input-group">
                <input type="text" id="search" name="search" class="form-control" placeholder="Search..." value="{{ search_term }}" >
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
    </div>

    <!-- Content Area with Beats -->
    <div class="content-area" style="height: calc(100vh - 220px); overflow-y: auto; margin-top: 20px; padding: 20px;">
        {% if beats %}
        {% for beat in beats %}
        <a href="{% url 'accounts:detail_beat' beat.id %}" style="color: #fff;">
        <div id="beat_{{ beat.id }}" class="beat-item" style="border-radius: 4px; padding: 0px; margin-bottom: 10px; position: relative;">

            <div id="THEDIV" style="display: flex; flex-wrap: wrap; position: relative;">
                <div style="flex: 1 0 200px; margin-right: 20px; position: relative; overflow: hidden;">
                    <div style="position: relative;">
                        <img class="rounded square-image-small gradientDiv" src="{{ beat.cover_image.url }}" alt="{{ beat.title }} Cover" style="width: 100%; border-radius: 1px; top: 65px;">
                        {% if beat.title|upper|length > 9 %}
                        <h1 style="position: absolute; top:95px; left:10px;" class="noselect"><strong>{{ beat.title|uppercase_and_slice }}...</strong></h1>
                        {% else %}
                        <h1 style="position: absolute; top:95px; left:10px;" class="noselect"><strong>{{ beat.title.upper }}</strong></h1>
                        {% endif %}
                        <div style="position: relative; top: 20px; left: 65%; background-color: rgba(31, 31, 31, 0.473); width: 220px; max-height: 80px;">
                            <h1 style="overflow-wrap: break-word;" class="beatArtist">
                                <strong><a href="{% url 'accounts:profile' beat.artist.username %}" style="color: #fff;">{{ beat.artist }}</a></strong>
                            </h1>
                            {% if beat.artist|get_artist_rank == 'admin' %}
                            <p style="position: absolute; color: red;">
                                <strong>{{ beat.artist|get_artist_rank }}</strong>
                            </p>
                            {% elif beat.artist|get_artist_rank == 'diamond' %}
                            <p style="position: absolute; color: rgb(50, 110, 187);">
                                <strong>{{ beat.artist|get_artist_rank }}</strong>
                            </p>
                            {% else %}
                            <p style="position: absolute;">
                                <strong>{{ beat.artist|get_artist_rank }}</strong>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    <a href="{% url 'accounts:detail_beat' beat.id %}">
                        <img class="square-image-small coverimage" src="{{ beat.cover_image.url }}" alt="{{ beat.title }} Cover Overlay" style="width: 140px; height: 140px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-top-right-radius: 4px; border-bottom-right-radius: 4px;">
                    </a>
                </div>
                <div style="height: 100%;  background-color: #007bff;"></div>
                <div style="flex: 2 0 0; margin-right: 0px; display: flex; flex-wrap: wrap; padding: 20px;width: 300px;">
                    <div style="display: flex;">
                        <p style="color: #666; margin-bottom: 5px;">{{ beat.genre }} - {{ beat.release_date }}</p>
                    </div>
                    {% if beat.audio_file_url %}
                    <div style="width: 100%; margin-top: 10px;">
                        <audio id="audio_{{ beat.id }}" controls style="width: 100%;" ontimeupdate="updateProgressBar({{ beat.id }})">
                            <source src="{{ beat.audio_file_url }}" type="audio/mp3">
                            Your browser does not support the audio element.
                        </audio>
                        
                        <div class="audio-controls">
                            <!-- @ts-ignore -->
                            <!-- eslint-disable-next-line  -->
                            <button onclick="togglePlayPause({{ beat.id }})" style="position: relative ;">
                                <!-- eslint-enable-next-line -->
                                <i id="play_icon_{{ beat.id }}" class="fa-solid fa-play"></i>
                                <i id="pause_icon_{{ beat.id }}" class="fas fa-pause" style="display: none;"></i>
                            </button>
                            <input type="range" id="seekbar_{{ beat.id }}" min="0" max="{{ beat.duration }}" step="1" value='0' class="seekbar" onchange="seekAudio({{ beat.id }})" oninput="updateSeekbarTooltip(this)">
                            <div id="seekbar_tooltip_{{ beat.id }}" class="seekbar-tooltip" style=" height: 34px; padding-top: 4px;">0:00</div>
                        </div>
                        <progress id="progress_{{ beat.id }}" value="0" max="100" style="opacity: 0%;"></progress>
                        <div style="min-height: 54px; min-width: 815.22;">
                            <h3><strong>{{ beat.price }} â‚¬</strong>
                                <div style="margin-left: 200px;height: 10px;  display: flex;justify-content: space-around;width: 200px;">
                                    <i class="fa-solid fa-heart fa-sm" style="color: #ff0000;"></i>
                                    <i class="fa-solid fa-bookmark fa-sm" style="color: #ffffff;"></i>
                                    <i class="fa-solid fa-comment fa-sm" style="color: #ffffff;"></i>
                                    <i class="fa-solid fa-link fa-sm pointerCursor" style="color: #ffffff;" onclick="copyLink('{% url 'accounts:detail_beat' beat.id %}')"></i>
                                </div>
                            </h3>
                        </div>
                        
                    </div>
                    
                    {% else %}
                    <p style="color: #999;">Audio file not found.</p>
                    {% endif %}
                    
                </div>
                <div style="height: 196px;width: 10%; display: flex;flex-direction: column  ;justify-content:space-around ;align-items: center;">
                    <i class="fa-solid fa-heart" style="color: #ff0000;"></i>
                    <i class="fa-solid fa-bookmark" style="color: #ffffff;"></i>
                    <i class="fa-solid fa-comment" style="color: #ffffff;"></i>
                    <i class="fa-solid fa-share" style="color: #ffffff;"></i>
                </div>
            </div>
        </div>
        </a>
        {% endfor %}
        {% else %}
        <p style="color: #999;"> {{ error }} </p>
        {% endif %}
    </div>

</main>
</div>

<style>
    h1 {
        font-size: 200%;
    }

    .gradientDiv {
        position: absolute;
        top: 50px;
        left: 0;
        transform: translate(-50%, -50%);
        -webkit-mask-image: -webkit-gradient(linear, left top, right top, from(rgba(0, 0, 0, 1)), """oui c'est rouge mais c'est juste la couleur c juste tkt"""
            to(rgba(0, 0, 0, 0)));
        mask-image: linear-gradient(to right, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0));
    }

    audio {
        display: none;
    }

    input[type=text], input[type=password], input[type=email], input[type=url], input[type=number], input[type=tel], textarea, select, .vTextField .form-control {
        background: #fff;
        background-color: #fff;
    }

    audio::-webkit-media-controls-panel {
        background-color: rgb(51, 51, 51);
    }

    .audio-controls {
        display: flex;
        justify-content: space-around;
        margin-top: 5px;
        width: 500px;
    }

    .audio-controls button {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
    }

    .play-btn {
        position: relative;
        height: 34px;
    }

    .audio-controls button:hover {
        background-color: #0056b3;
    }

    #THEDIV {
        transition: all 0.1s ease-in;
    }
    .beatArtist:hover {
        text-decoration: underline;
        cursor: pointer;
    }
    #THEDIV:hover {
        -webkit-box-shadow: 0px 0px 16px 8px rgba(0, 0, 0, 0.61);
        box-shadow: 0px 0px 16px 8px rgba(0, 0, 0, 0.31);
        margin-bottom: 2px;
        background-color: #2d373f5d;
    }
    #arrowdiv {
      position: relative;
      height: 100%; 
      width: 80px; 
      background-color: #1b1b1b00; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      transition: all, 0.1s, ease-in-out;
      padding: 0 8px;
      left: 0%;
      transform: translate(0%, 0%);
      cursor: pointer;
      z-index: 1100;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease-in-out;
    }
    #arrowdiv.collapsed {
    left: -310px; /* Adjusted left position when collapsed */
}

    #arrowdiv:hover {
      background-color: #1b1b1bFF;
    }
    #sidebar {
        background-color: rgb(29, 29, 29);
        transition: transform 0.3s ease-in-out;
        z-index: 1000;
    }
    #sidebar.collapsed {
        transform: translateX(-320px); /* Collapsed position */
        display: none;
    }
    .seekbar {
        position: relative;
        width: 160px;
        margin-top: 4px;
        background-color: #66666600;
    }

    .audio-controls button {
        background-color: #ffffff00;
        height: 34px;
        width: 34px;
    }

    .audio-controls:hover button:hover {
        background-color: #ffffff31;
        border-radius: 3px;
    }
    #main-content {
      transition: transform 0.3s ease-in-out;
    }
    #main-content.collapsed {
      transform: translateX(-300px);
    }
    .col-12 {
        width: 100%;
    }
    .noselect {
  -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */
}
.pointerCursor{
    cursor: pointer;
}

</style>

<script>
  function togglePlayPause(beatId) {
      var audio = document.getElementById('audio_' + beatId);
      var playIcon = document.getElementById('play_icon_' + beatId);
      var pauseIcon = document.getElementById('pause_icon_' + beatId);
      var allAudios = document.querySelectorAll('audio');
  
      // Pause all other audios
      allAudios.forEach(function(aud) {
          if (aud.id !== 'audio_' + beatId) {
              aud.pause();
              var otherBeatId = aud.id.split('_')[1];
              var otherPlayIcon = document.getElementById('play_icon_' + otherBeatId);
              var otherPauseIcon = document.getElementById('pause_icon_' + otherBeatId);
              otherPlayIcon.style.display = 'inline-block';
              otherPauseIcon.style.display = 'none';
          }
      });
  
      // Toggle play/pause for the selected beat
      if (audio.paused) {
          audio.play();
          playIcon.style.display = 'none';
          pauseIcon.style.display = 'inline-block';
      } else {
          audio.pause();
          playIcon.style.display = 'inline-block';
          pauseIcon.style.display = 'none';
      }
  }
  function copyLink(copyText) {
    copyText = 'http://192.168.1.26:8000' + copyText;
    if (!navigator.clipboard) {
        // Fallback for browsers that do not support navigator.clipboard
        var textArea = document.createElement("textarea");
        textArea.value = copyText;
        textArea.style.position = "fixed";  // Make it invisible but selectable
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            var successful = document.execCommand('copy');
            var msg = successful ? 'successful' : 'unsuccessful';
            console.log('Fallback: Copying text command was ' + msg);
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
        return;
    }
    
    // Modern browsers with navigator.clipboard support
    navigator.clipboard.writeText(`hello`)
        .then(() => {
            alert("Copied the link to clipboard: " + copyText);
        })
        .catch(err => {
            console.error('Unable to copy: ', err);
        });
}
  function seekAudio(beatId) {
      var audio = document.getElementById('audio_' + beatId);
      var seekbar = document.getElementById('seekbar_' + beatId);
      var value = seekbar.value;
      audio.currentTime = value;
  }
  
  function updateProgressBar(beatId) {
      var audio = document.getElementById('audio_' + beatId);
      var progressBar = document.getElementById('progress_' + beatId);
      var seekbar = document.getElementById('seekbar_' + beatId);
  
      var value = (audio.currentTime / audio.duration) * 100;
      progressBar.value = value;
      seekbar.value = audio.currentTime;
  
      updateSeekbarTooltip(seekbar);
  }
  
  function updateSeekbarTooltip(seekbar) {
      var tooltip = seekbar.nextElementSibling;
      var value = seekbar.value;
      var minutes = Math.floor(value / 60);
      var seconds = Math.floor(value % 60);
      var time = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
      tooltip.innerHTML = time;
      tooltip.style.left = (value / seekbar.max) * 100 + '%';
  }
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const arrowIcon = document.querySelector('#arrowdiv i');
    const arrowDiv = document.getElementById('arrowdiv');
    const mainContent = document.getElementById('main-content');

    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('collapsed');
    arrowDiv.classList.toggle('collapsed');

    // Toggle between fa-chevron-left and fa-chevron-right
    if (sidebar.classList.contains('collapsed')) {
        arrowIcon.classList.remove('fa-chevron-left');
        arrowIcon.classList.add('fa-chevron-right');
    } else {
        arrowIcon.classList.remove('fa-chevron-right');
        arrowIcon.classList.add('fa-chevron-left');
    }
}

document.getElementById('arrowdiv').addEventListener('click', toggleSidebar);


</script>

{% endblock content %}
